name: cd-smoke

on:
  workflow_run:
    workflows: ["cd-deploy"] # careful w/o name, IIRC has to be the "name" not the file name w/o prefix... # TODO double check this
    types:
      - completed # both success,failure # use condition in steps => if: ${{ github.event.workflow_run.conclusion == 'success' }}
  workflow_dispatch: # manual # doesn't likely make sense if I rely on passing state (ie URL, REF, etc)

jobs:
  smokeit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # git describe --tags # in smoke-test.sh
      - run: curl -fsSL "http://gh-actions-web-api.azurewebsites.net/" # PRN pass url arg?s

      - run: ./smoke-test.sh
        working-directory: api

      # https://github.com/marketplace/actions/url-health-check
      - name: URL Health Check
        uses: Jtalk/url-health-check-action@v4
        with:
          # https://github.com/Jtalk/url-health-check-action/blob/master/action.yml
          url: "http://gh-actions-web-api.azurewebsites.net/version"
          max-attempts: 2
          retry-delay: 5s
          # follow-redirect: true
